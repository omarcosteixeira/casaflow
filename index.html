<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa Flow - Sistema de Controle Doméstico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f3f4f6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
        }
        .nav-active {
            background-color: var(--primary-color);
            color: white !important;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #059669;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .low-stock {
            background-color: #fefce8;
            border-left: 4px solid var(--warning-color);
        }
    </style>
</head>
<body class="h-screen">

    <!-- Tela de Login/Cadastro -->
    <div id="auth-screen" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md">
            <div id="login-container">
                <form id="form-login" class="bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
                    <div class="mb-6 text-center">
                        <i class="fas fa-house-user text-5xl text-indigo-600"></i>
                        <h1 class="text-3xl font-bold mt-2 text-gray-800">Bem-vindo ao Casa Flow</h1>
                        <p class="text-gray-500">Faça login para continuar</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="login-email">Email</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="login-email" type="email" placeholder="seu@email.com" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="login-password">Senha</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="login-password" type="password" placeholder="******************" required>
                    </div>
                     <p id="login-error" class="text-red-500 text-xs italic mb-4 text-center"></p>
                    <div class="flex items-center justify-between">
                        <button class="btn btn-primary w-full" type="submit">Entrar</button>
                    </div>
                    <p class="text-center text-gray-500 text-xs mt-6">
                        Não tem uma conta? <a href="#" id="show-signup" class="text-indigo-600 hover:text-indigo-800">Cadastre-se</a>
                    </p>
                </form>
            </div>
            <div id="signup-container" class="hidden">
                 <form id="form-signup" class="bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
                    <div class="mb-6 text-center">
                         <h1 class="text-3xl font-bold text-gray-800">Crie sua Conta</h1>
                         <p class="text-gray-500">Rápido e fácil</p>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="signup-email">Email</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="signup-email" type="email" placeholder="Email" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="signup-password">Senha</label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="signup-password" type="password" placeholder="******************" required>
                    </div>
                     <p id="signup-error" class="text-red-500 text-xs italic mb-4 text-center"></p>
                    <div class="flex items-center justify-between">
                        <button class="btn btn-primary w-full" type="submit">Cadastrar</button>
                    </div>
                     <p class="text-center text-gray-500 text-xs mt-6">
                        Já tem uma conta? <a href="#" id="show-login" class="text-indigo-600 hover:text-indigo-800">Faça Login</a>
                    </p>
                </form>
            </div>
             <div id="message-container" class="hidden text-center bg-white p-8 rounded-lg shadow-md">
                 <h2 id="message-title" class="text-2xl font-bold text-gray-800"></h2>
                 <p id="message-text" class="text-gray-600 mt-2"></p>
                 <button id="message-logout-btn" class="btn btn-primary mt-6">OK, Sair</button>
            </div>
        </div>
    </div>
    
    <!-- Aplicação Principal (oculta por padrão) -->
    <div id="app-container" class="hidden h-screen w-full flex">
        <!-- Sidebar de Navegação -->
        <aside class="w-20 md:w-64 bg-white shadow-md flex flex-col items-center md:items-start p-4 space-y-6">
            <div class="flex items-center justify-center w-full mb-6">
                 <i class="fas fa-house-user text-3xl text-indigo-600"></i>
                 <h1 class="hidden md:block text-2xl font-bold ml-3 text-gray-800">Casa Flow</h1>
            </div>
            <nav class="w-full flex flex-col items-center md:items-stretch space-y-3 flex-1">
                <a href="#" id="nav-financas" class="nav-link flex items-center justify-center md:justify-start p-3 rounded-lg text-gray-600 hover:bg-indigo-100 nav-active">
                    <i class="fas fa-wallet w-8 text-center text-xl"></i>
                    <span class="hidden md:block ml-4 font-semibold">Finanças</span>
                </a>
                <a href="#" id="nav-estoque" class="nav-link flex items-center justify-center md:justify-start p-3 rounded-lg text-gray-600 hover:bg-indigo-100">
                    <i class="fas fa-boxes-stacked w-8 text-center text-xl"></i>
                    <span class="hidden md:block ml-4 font-semibold">Estoque</span>
                </a>
                <a href="#" id="nav-tarefas" class="nav-link flex items-center justify-center md:justify-start p-3 rounded-lg text-gray-600 hover:bg-indigo-100">
                    <i class="fas fa-tasks w-8 text-center text-xl"></i>
                    <span class="hidden md:block ml-4 font-semibold">Tarefas</span>
                </a>
                <a href="#" id="nav-autenticar" class="nav-link hidden flex items-center justify-center md:justify-start p-3 rounded-lg text-gray-600 hover:bg-indigo-100">
                    <i class="fas fa-user-check w-8 text-center text-xl"></i>
                    <span class="hidden md:block ml-4 font-semibold">Autenticar</span>
                </a>
            </nav>
            <div class="mt-auto w-full">
                 <div id="auth-status" class="hidden md:flex flex-col text-center text-xs text-gray-500 p-2 border-t">
                     <span id="user-email" class="font-semibold truncate"></span>
                     <span id="user-role" class="text-indigo-500"></span>
                 </div>
                 <button id="logout-btn" class="w-full btn bg-red-500 text-white hover:bg-red-600 flex items-center justify-center md:justify-start p-3">
                    <i class="fas fa-sign-out-alt w-8 text-center text-xl"></i>
                    <span class="hidden md:block ml-4 font-semibold">Sair</span>
                 </button>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">

            <!-- Seção Finanças -->
            <section id="financas" class="page">
                <!-- Conteúdo de finanças aqui (inalterado) -->
            </section>

            <!-- Seção Estoque -->
            <section id="estoque" class="page hidden">
                 <!-- Conteúdo de estoque aqui (inalterado) -->
            </section>

            <!-- Seção Tarefas -->
            <section id="tarefas" class="page hidden">
                 <!-- Conteúdo de tarefas aqui (inalterado) -->
            </section>
            
            <!-- Seção Autenticar (Admin) -->
            <section id="autenticar" class="page hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Gerenciamento de Usuários</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Usuários Pendentes -->
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-yellow-600 mb-4">Pendentes de Aprovação</h3>
                        <div id="pending-users" class="space-y-3"></div>
                    </div>
                     <!-- Usuários Ativos -->
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-green-600 mb-4">Usuários Ativos</h3>
                        <div id="active-users" class="space-y-3"></div>
                    </div>
                     <!-- Usuários Bloqueados -->
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-red-600 mb-4">Usuários Bloqueados</h3>
                        <div id="blocked-users" class="space-y-3"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, query, limit, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzasnYtePx93fALw277HePUrn4IkxFxew",
            authDomain: "casa-flow.firebaseapp.com",
            projectId: "casa-flow",
            storageBucket: "casa-flow.appspot.com",
            messagingSenderId: "1056932151529",
            appId: "1:1056932151529:web:17dbcc30ec3f3c7ffbb078"
        };
        
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        // Initialize Firebase
        const app = initializeApp(finalFirebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL APP STATE ---
        let financas = { transacoes: [], cartoes: [], parcelamentos: [] };
        let estoque = [];
        let tarefas = [];
        let currentUser = null;
        let unsubscribeData;

        // --- UI ELEMENTS ---
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const messageContainer = document.getElementById('message-container');
        
        // --- AUTHENTICATION & USER MANAGEMENT ---
        onAuthStateChanged(auth, async user => {
            if (unsubscribeData) unsubscribeData(); // Unsubscribe from old listener
            
            if (user) {
                const userProfileRef = doc(db, "users", user.uid);
                const userProfileSnap = await getDoc(userProfileRef);

                if (userProfileSnap.exists()) {
                    currentUser = { uid: user.uid, email: user.email, ...userProfileSnap.data() };
                    handleUserStatus(currentUser);
                }
            } else {
                currentUser = null;
                showAuthScreen('login');
            }
        });
        
        function handleUserStatus(user) {
            switch(user.status) {
                case 'active':
                    initializeAppForUser(user);
                    break;
                case 'pending':
                    showAuthScreen('message', 'Aguardando Aprovação', 'Sua conta foi criada e está aguardando a aprovação de um administrador.');
                    break;
                case 'blocked':
                    showAuthScreen('message', 'Conta Bloqueada', 'Sua conta foi bloqueada. Entre em contato com o administrador.');
                    break;
                default:
                    showAuthScreen('login');
            }
        }
        
        function initializeAppForUser(user) {
            authScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            
            // Update UI with user info
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-role').textContent = user.role === 'admin' ? 'Administrador' : 'Usuário';

            // Show admin tab if user is admin
            const adminNav = document.getElementById('nav-autenticar');
            if (user.role === 'admin') {
                adminNav.classList.remove('hidden');
                adminNav.classList.add('flex');
                loadAdminUsers();
            } else {
                adminNav.classList.add('hidden');
            }

            // Listen for data changes
            const dataRef = doc(db, "appData", user.uid);
            unsubscribeData = onSnapshot(dataRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    financas = data.financas || { transacoes: [], cartoes: [], parcelamentos: [] };
                    estoque = data.estoque || [];
                    tarefas = data.tarefas || [];
                } else {
                    // First time, initialize empty data
                    financas = { transacoes: [], cartoes: [], parcelamentos: [] };
                    estoque = [];
                    tarefas = [];
                }
                renderAll();
            });
        }
        
        // --- ADMIN PANEL ---
        async function loadAdminUsers() {
            const usersRef = collection(db, "users");
            const usersSnapshot = await getDocs(usersRef);
            
            const pendingUsersEl = document.getElementById('pending-users');
            const activeUsersEl = document.getElementById('active-users');
            const blockedUsersEl = document.getElementById('blocked-users');

            pendingUsersEl.innerHTML = '';
            activeUsersEl.innerHTML = '';
            blockedUsersEl.innerHTML = '';
            
            let hasPending = false, hasActive = false, hasBlocked = false;

            usersSnapshot.forEach(doc => {
                const user = { id: doc.id, ...doc.data() };
                if(user.id === currentUser.uid) return; // Don't show admin themselves

                const userCard = document.createElement('div');
                userCard.className = 'p-3 bg-gray-100 rounded-lg';
                
                let buttons = '';
                if(user.status === 'pending') {
                    buttons = `<button class="btn btn-secondary text-xs p-1" onclick="updateUserStatus('${user.id}', 'active')">Aprovar</button>`;
                } else if (user.status === 'active') {
                    buttons = `<button class="btn btn-danger text-xs p-1" onclick="updateUserStatus('${user.id}', 'blocked')">Bloquear</button>`;
                } else if (user.status === 'blocked') {
                    buttons = `<button class="btn btn-secondary text-xs p-1" onclick="updateUserStatus('${user.id}', 'active')">Desbloquear</button>`;
                }

                userCard.innerHTML = `
                    <p class="font-semibold truncate">${user.email}</p>
                    <div class="flex justify-end mt-2">
                        ${buttons}
                    </div>
                `;

                if (user.status === 'pending') {
                    pendingUsersEl.appendChild(userCard);
                    hasPending = true;
                } else if (user.status === 'active') {
                    activeUsersEl.appendChild(userCard);
                    hasActive = true;
                } else {
                    blockedUsersEl.appendChild(userCard);
                    hasBlocked = true;
                }
            });
            
            if(!hasPending) pendingUsersEl.innerHTML = `<p class="text-gray-500 text-sm">Nenhum usuário pendente.</p>`;
            if(!hasActive) activeUsersEl.innerHTML = `<p class="text-gray-500 text-sm">Nenhum usuário ativo.</p>`;
            if(!hasBlocked) blockedUsersEl.innerHTML = `<p class="text-gray-500 text-sm">Nenhum usuário bloqueado.</p>`;
        }
        
        window.updateUserStatus = async (uid, newStatus) => {
            const userRef = doc(db, "users", uid);
            await updateDoc(userRef, { status: newStatus });
            loadAdminUsers(); // Refresh the list
        };
        
        // --- UI & FORMS LOGIC ---
        function showAuthScreen(screen, title = '', text = '') {
            appContainer.classList.add('hidden');
            authScreen.classList.remove('hidden');

            loginContainer.classList.add('hidden');
            signupContainer.classList.add('hidden');
            messageContainer.classList.add('hidden');

            if (screen === 'login') {
                loginContainer.classList.remove('hidden');
            } else if (screen === 'signup') {
                signupContainer.classList.remove('hidden');
            } else if (screen === 'message') {
                document.getElementById('message-title').textContent = title;
                document.getElementById('message-text').textContent = text;
                messageContainer.classList.remove('hidden');
            }
        }
        
        document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); showAuthScreen('signup'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showAuthScreen('login'); });
        
        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            try {
                errorEl.textContent = '';
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = 'Email ou senha inválidos.';
            }
        });
        
        document.getElementById('form-signup').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');
            
            try {
                errorEl.textContent = '';
                // Check if any user exists to determine admin role
                const usersQuery = query(collection(db, "users"), limit(1));
                const querySnapshot = await getDocs(usersQuery);
                const isFirstUser = querySnapshot.empty;

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Create user profile
                await setDoc(doc(db, "users", user.uid), {
                    email: user.email,
                    role: isFirstUser ? 'admin' : 'user',
                    status: isFirstUser ? 'active' : 'pending'
                });
                
                // Create user data document
                await setDoc(doc(db, "appData", user.uid), {
                    financas: { transacoes: [], cartoes: [], parcelamentos: [] },
                    estoque: [],
                    tarefas: []
                });
                
                // User will be handled by onAuthStateChanged after this
                
            } catch (error) {
                 if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = 'Este email já está em uso.';
                } else {
                    errorEl.textContent = 'Ocorreu um erro no cadastro.';
                }
            }
        });

        const logout = () => {
            signOut(auth);
        };
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('message-logout-btn').addEventListener('click', logout);


        // --- APPLICATION LOGIC (FINANÇAS, ESTOQUE, TAREFAS) ---
        // (O código das seções Finanças, Estoque e Tarefas permanece aqui,
        // mas as funções de salvar/carregar dados foram substituídas pela lógica do Firebase)

        // The saveDataToFirebase function now updates the single document
        async function saveDataToFirebase() {
            if (!currentUser) return;
            try {
                const dataRef = doc(db, "appData", currentUser.uid);
                await setDoc(dataRef, { financas, estoque, tarefas });
            } catch (error) {
                console.error("Error saving data: ", error);
            }
        }
        
        // Example of how a function is adapted:
        window.deletarTransacao = (id) => { 
            financas.transacoes = financas.transacoes.filter(t => t.id !== id);
            saveDataToFirebase();
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            // All initialization logic is now handled by onAuthStateChanged
            
            // Setup navigation
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            function showPage(pageId) {
                pages.forEach(page => page.classList.add('hidden'));
                document.getElementById(pageId).classList.remove('hidden');
                navLinks.forEach(link => link.classList.remove('nav-active'));
                document.getElementById(`nav-${pageId}`).classList.add('nav-active');
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.id.split('-')[1];
                    showPage(pageId);
                });
            });
            showPage('financas');
        });

        // Placeholder for the rest of the application logic
        function renderAll() { console.log("Rendering all data views..."); }
        
    </script>
</body>
</html>

